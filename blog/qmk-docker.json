{"date":"2020-10-5","title":"Flashing QMK Firmware With The Help Of Docker","desc":"We explore a way to self-contain QMK dependencies use for flashing popular DIY keyboards.","file":"qmk-docker","html":"<h1>Flashing QMK Firmware With The Help Of Docker</h1>\n<p>DIY keyboard enthusiasts enjoy soldering switches, compiling firmware, and flashing their own keyboards.\n<a href=\"https://beta.docs.qmk.fm\">QMK</a> provides open-source firmware and tooling to make this process transparent and easy.</p>\n<p>While working on my own keyboard project I ran into a road block.\nFedora 32 is my operating system of choice and ships with GCC 10 by default.</p>\n<p>QMK requires AVR-GCC and GCC verion 8 to successfully flash a keyboard.\nBy default the Fedora RPM repos do not provide a down-grade path and you'd probably not want to do this anyway.</p>\n<p>Instead we can use a Docker container with the correct dependencies as our build environment.</p>\n<h2>GCC 8 Container</h2>\n<p>GCC containers are published on <a href=\"https://hub.docker.com/_/gcc\">Docker Hub</a>.\nLooking over the tags reveal a <code>gcc:8</code> tag suitable for our build environment.</p>\n<h2>Dockerfile</h2>\n<p>The base <code>gcc:8</code> container will need additional dependencies and setup.</p>\n<p>The following Dockerfile demonstrates what is necessary.</p>\n<pre class=\"hljs\"><code>FROM gcc:8\n\nRUN apt-get update &amp;&amp; export PATH=$PATH:/root/.local/bin\nRUN apt install -y gcc-arm-none-eabi gcc-avr avrdude dfu-programmer dfu-util\n\nRUN curl https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py &amp;&amp; python3 /tmp/get-pip.py\nRUN python3 -m pip install qmk\nRUN qmk setup -y\n\nENTRYPOINT /bin/bash\n</code></pre>\n<p>We can build this container with the following command:</p>\n<pre class=\"hljs\"><code><span class=\"hljs-meta\">$</span><span class=\"bash\"> docker build -t qmk:latest .</span>\n</code></pre>\n<p>The above command should be ran while your shell is in the same directory of the Dockerfile.</p>\n<h2>Running The Container</h2>\n<p>The plan is to build the firmware in our container, where the necessary dependencies exist, get the hex file on our workstation, and flash the usb keyboard outside of the container.</p>\n<p>In order to do this we must mount a directory from our workstation into the QMK container.</p>\n<pre class=\"hljs\"><code><span class=\"hljs-meta\">$</span><span class=\"bash\"> mkdir ~/qmk-mnt</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> docker run -it -v /home/ldelossa/qmk-mnt:/mnt quay.io/ldelossa/qmk:latest</span>\n</code></pre>\n<p>The above command creates a qmk-mnt folder in my home directory and bind mounts this into the container at /mnt.\nAny files moved or copied to /mnt in the container will be accessable at ~/qmk-mnt on the host workstation.</p>\n<h2>Building Your Firmware</h2>\n<p>Once inside the container we can build the firwmare and copy it to /mnt.</p>\n<p>I personally have an OLKB Preonic keyboard and will use the default keymap as an example.</p>\n<p>Inside the container run the following command:</p>\n<pre class=\"hljs\"><code>qmk compile -kb preonic/rev1 -km default\n</code></pre>\n<p>The above command compiles the default keymap and writes the resulting elf and hex binaries to:</p>\n<pre class=\"hljs\"><code>./root/qmk_firmware/.build/\n</code></pre>\n<p>For the preonic keyboard I am using we want to copy the &quot;.hex&quot; file to /mnt inside the container.\nThis will make it accessable from ~/qmk-mnt on the host workstation.</p>\n<pre class=\"hljs\"><code><span class=\"hljs-meta\">$</span><span class=\"bash\"> cp /root/qmk_firmware/.build/preonic_rev1_default.hex /mnt/</span>\n</code></pre>\n<h2>Flashing The Keyboard</h2>\n<p>Now that the firmware exists on the host workstation its possible to flash our keyboard.</p>\n<p>The preonic keyboard will need &quot;dfu-programmer&quot; to write the hex file to the keyboard's micro-controller.\nLuckily this package is readily available on both Fedora and Ubuntu along with other distributions.</p>\n<p>With the keyboard plugged into the host and placed in &quot;flash&quot; mode the following commands are issued:</p>\n<pre class=\"hljs\"><code><span class=\"hljs-meta\">$</span><span class=\"bash\"> sudo dfu-programmer atmega32u4 erase</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> sudo dfu-programmer atmega32u4 flash ~/qmk-mnt/preonic_rev1_default.hex</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> sudo dfu-programmer atmega32u4 reset</span>\n</code></pre>\n<p>The commands erase the current firmware, flash the new one, and restarts the keyboard.</p>\n<h2>Building A Keymap</h2>\n<p>From here you can use the QMK container to build your own keymaps.</p>\n<p>By copying the default keymaps to the /mnt folder inside the container its possible to edit the file on the host.\nOnce edited simply copy it back to the original keymap folder and use QMK to compile it to a &quot;.hex&quot; file.</p>\n<p>For full details check out the <a href=\"https://beta.docs.qmk.fm/tutorial\">getting started tutorial</a>.\nMoving the examples here into the demonstrated container workflow should be straight forward.</p>\n<h2>Saving Your Container</h2>\n<p>It is possible to &quot;commit&quot; the build environment if any changes are made to QMK's configuration.</p>\n<p>To do this you can perform a Docker commit command:</p>\n<pre class=\"hljs\"><code><span class=\"hljs-meta\">$</span><span class=\"bash\"> docker commit stoic_nash qmk:custom-config</span>\n\n</code></pre>\n<p>The command above will create a new container called <code>qmk:custom-config</code> based on the currently running container <code>stoic-nash</code>, a random name picked by Docker for our qmk container.</p>\n<h2>Conclusion</h2>\n<p>With this short guide we make it possible to build QMK firmware in a self-contained environment.\nWe remove any need to install or downgrade versions of GCC and other dependencies on your host machine.</p>\n"}