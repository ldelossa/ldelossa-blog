<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <base href=/ > <link href=global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <link href=https://meyerweb.com/eric/tools/css/reset/reset.css rel=stylesheet> <link href="https://fonts.googleapis.com/css2?family=Baloo+Paaji+2:wght@500&display=swap" rel=stylesheet> <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap" rel=stylesheet> <link href="https://fonts.googleapis.com/css2?family=Muli&display=swap" rel=stylesheet> <link href=github-markdown.css rel=stylesheet> <link href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/zenburn.min.css rel=stylesheet> <script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js></script> <script src=//gc.zgo.at/count.js async data-goatcounter=https://ldelossa.goatcounter.com/count></script> <style>.layout.svelte-lybuj1{display:grid;height:100vh;width:100vw;grid-template-columns:1.5fr 6fr}.content-wrapper.svelte-lybuj1{grid-area:1/2/2/3;overflow-y:auto}.content-wrapper-full.svelte-lybuj1{grid-area:1/1/2/3}@media screen and (max-width:600px){.layout.svelte-lybuj1{display:grid;grid-template-columns:1fr}.content-wrapper.svelte-lybuj1{z-index:1}.content-wrapper-full.svelte-lybuj1{z-index:1}}.sidebar-open.svelte-posnvr{display:flex;justify-content:space-between;flex-direction:column;height:100vh;max-width:300px;min-width:275px;margin-right:1vmin;background:#4b6777;overflow-y:hidden}.sidebar-closed.svelte-posnvr{display:none}.sb-toggle-button-open.svelte-posnvr{z-index:100;outline:0;background-color:Transparent;border:none;padding:10px 12px;font-size:30px;cursor:pointer;color:#f3f8f2;font-family:Muli,cursive;position:fixed;left:0}.sb-toggle-button-open.svelte-posnvr:hover{color:#f2511b}.sb-toggle-button-closed.svelte-posnvr{z-index:100;outline:0;background-color:Transparent;border:none;padding:10px 12px;font-size:30px;cursor:pointer;color:#4b6777;font-family:Muli,cursive;position:fixed;left:0}.sb-toggle-button-closed.svelte-posnvr:hover{color:#f2511b}.author-wrapper.svelte-posnvr{display:flex;flex-direction:column;justify-content:center;margin:40px}.author.svelte-posnvr{text-align:center;font-size:2rem;color:#f3f8f2;font-family:Muli,sans-serif;letter-spacing:1px;text-shadow:2px 2px 0 rgba(0,0,0,.35),2px 2px 5px rgba(0,0,0,.5)}.console-wrapper.svelte-posnvr{display:flex;margin:20px;justify-content:center}nav.svelte-posnvr{display:flex;flex-direction:column;justify-content:space-around;flex-wrap:wrap}.icons-wrapper.svelte-posnvr{display:flex;flex-direction:column;justify-content:flex-end;padding:20px}@media screen and (max-width:600px){.sidebar-open.svelte-posnvr{-moz-box-shadow:initial;-webkit-box-shadow:initial;box-shadow:initial;max-width:initial;min-width:initial;margin-right:initial;border-right:initial;height:100vh;width:100vw}.icons-wrapper.svelte-posnvr{display:flex;grid-area:icons;flex-direction:column;justify-content:space-between}}pre.svelte-wc9ma6 code.svelte-wc9ma6{border-radius:3%;padding:8px;display:block;min-width:230px;max-width:275px;background:#333;color:#737373}.button-wrapper.svelte-n868dk{text-align:center;margin:1rem 0 1rem 0;padding:1rem 1rem 1rem 1rem}.button-ref.svelte-n868dk{text-decoration:underline;font-size:30px;color:#e9f1f7;font-family:Muli,sans-serif;letter-spacing:1px;text-shadow:2px 2px 0 rgba(0,0,0,.35),2px 2px 5px rgba(0,0,0,.5)}.button-ref.svelte-n868dk:hover{color:#f2511b;text-shadow:-1px -1px 0 rgba(242,81,27,.5),-1px -1px -5px rgba(242,81,27,.5)}.icons.svelte-13lfieo{display:flex;flex-direction:row;justify-content:space-around;flex-wrap:wrap}img.svelte-13lfieo{width:30px;height:30px}img.svelte-13lfieo:hover{-webkit-filter:drop-shadow(2px 2px 2px #222);filter:drop-shadow(2px 2px 2px #222)}.blog-wrapper.svelte-1ih628r{max-height:100vh;max-width:100vw}.markdown-body.svelte-1ih628r{min-width:100px;max-width:900px;margin:0 auto;padding:45px;color:#e9f1f7;font-family:Muli,sans-serif}@media(max-width:767px){.markdown-body.svelte-1ih628r{max-width:75%}}</style> <noscript id=sapper-head-start></noscript><title>Flashing QMK Firmware With The Help Of Docker</title><noscript id=sapper-head-end></noscript> <link href=/client/21d5f7fc0374dd879b15/main.js rel=preload as=script><link href=/client/21d5f7fc0374dd879b15/blog_$slug.2.js rel=preload as=script></head> <body> <div id=sapper> <div class="svelte-lybuj1 layout"><button class="svelte-posnvr sb-toggle-button-closed">☰</button> <div class="svelte-posnvr sidebar-closed"><div class="svelte-posnvr author-wrapper"><p class="svelte-posnvr author">Louis DeLosSantos<p><div class="svelte-posnvr console-wrapper"><pre class=svelte-wc9ma6><code class=svelte-wc9ma6>❯ tree ./ldelossa 
├── hardware
├── linux
├── music
└── software
❯ <span id=cursor>▊</span></code></pre></div></div> <nav class=svelte-posnvr><div class="svelte-n868dk button-wrapper"><a href=about class="svelte-n868dk button-ref">about</a></div> <div class="svelte-n868dk button-wrapper"><a href=resume class="svelte-n868dk button-ref">resume</a></div> <div class="svelte-n868dk button-wrapper"><a href=projects class="svelte-n868dk button-ref">projects</a></div> <div class="svelte-n868dk button-wrapper"><a href=blog class="svelte-n868dk button-ref">blog</a></div></nav> <div class="svelte-posnvr icons-wrapper"><div class="svelte-13lfieo icons"><a href=https://www.linkedin.com/in/louisdelossantos/ target=_blank><img alt="linkedin icon" class=svelte-13lfieo src=linkedin.svg></a> <a href=https://github.com/ldelossa target=_blank><img alt="github icon" class=svelte-13lfieo src=github.svg></a> <a href=https://twitter.com/ldelossa_ld target=_blank><img alt="twitter icon" class=svelte-13lfieo src=twitter.svg></a></div></div></div> <div class="svelte-lybuj1 content-wrapper-full"> <div class="svelte-1ih628r blog-wrapper"><article class="svelte-1ih628r markdown-body"><h1>Flashing QMK Firmware With The Help Of Docker</h1> <p>DIY keyboard enthusiasts enjoy soldering switches, compiling firmware, and flashing their own keyboards. <a href=https://beta.docs.qmk.fm>QMK</a> provides open-source firmware and tooling to make this process transparent and easy.</p> <p>While working on my own keyboard project I ran into a road block. Fedora 32 is my operating system of choice and ships with GCC 10 by default.</p> <p>QMK requires AVR-GCC and GCC verion 8 to successfully flash a keyboard. By default the Fedora RPM repos do not provide a down-grade path and you'd probably not want to do this anyway.</p> <p>Instead we can use a Docker container with the correct dependencies as our build environment.</p> <h2>GCC 8 Container</h2> <p>GCC containers are published on <a href=https://hub.docker.com/_/gcc>Docker Hub</a>. Looking over the tags reveal a <code>gcc:8</code> tag suitable for our build environment.</p> <h2>Dockerfile</h2> <p>The base <code>gcc:8</code> container will need additional dependencies and setup.</p> <p>The following Dockerfile demonstrates what is necessary.</p> <pre class=hljs><code>FROM gcc:8

RUN apt-get update && export PATH=$PATH:/root/.local/bin
RUN apt install -y gcc-arm-none-eabi gcc-avr avrdude dfu-programmer dfu-util

RUN curl https://bootstrap.pypa.io/get-pip.py -o /tmp/get-pip.py && python3 /tmp/get-pip.py
RUN python3 -m pip install qmk
RUN qmk setup -y

ENTRYPOINT /bin/bash
</code></pre> <p>We can build this container with the following command:</p> <pre class=hljs><code><span class=hljs-meta>$</span><span class=bash> docker build -t qmk:latest .</span>
</code></pre> <p>The above command should be ran while your shell is in the same directory of the Dockerfile.</p> <h2>Running The Container</h2> <p>The plan is to build the firmware in our container, where the necessary dependencies exist, get the hex file on our workstation, and flash the usb keyboard outside of the container.</p> <p>In order to do this we must mount a directory from our workstation into the QMK container.</p> <pre class=hljs><code><span class=hljs-meta>$</span><span class=bash> mkdir ~/qmk-mnt</span>
<span class=hljs-meta>$</span><span class=bash> docker run -it -v /home/ldelossa/qmk-mnt:/mnt quay.io/ldelossa/qmk:latest</span>
</code></pre> <p>The above command creates a qmk-mnt folder in my home directory and bind mounts this into the container at /mnt. Any files moved or copied to /mnt in the container will be accessable at ~/qmk-mnt on the host workstation.</p> <h2>Building Your Firmware</h2> <p>Once inside the container we can build the firwmare and copy it to /mnt.</p> <p>I personally have an OLKB Preonic keyboard and will use the default keymap as an example.</p> <p>Inside the container run the following command:</p> <pre class=hljs><code>qmk compile -kb preonic/rev1 -km default
</code></pre> <p>The above command compiles the default keymap and writes the resulting elf and hex binaries to:</p> <pre class=hljs><code>./root/qmk_firmware/.build/
</code></pre> <p>For the preonic keyboard I am using we want to copy the ".hex" file to /mnt inside the container. This will make it accessable from ~/qmk-mnt on the host workstation.</p> <pre class=hljs><code><span class=hljs-meta>$</span><span class=bash> cp /root/qmk_firmware/.build/preonic_rev1_default.hex /mnt/</span>
</code></pre> <h2>Flashing The Keyboard</h2> <p>Now that the firmware exists on the host workstation its possible to flash our keyboard.</p> <p>The preonic keyboard will need "dfu-programmer" to write the hex file to the keyboard's micro-controller. Luckily this package is readily available on both Fedora and Ubuntu along with other distributions.</p> <p>With the keyboard plugged into the host and placed in "flash" mode the following commands are issued:</p> <pre class=hljs><code><span class=hljs-meta>$</span><span class=bash> sudo dfu-programmer atmega32u4 erase</span>
<span class=hljs-meta>$</span><span class=bash> sudo dfu-programmer atmega32u4 flash ~/qmk-mnt/preonic_rev1_default.hex</span>
<span class=hljs-meta>$</span><span class=bash> sudo dfu-programmer atmega32u4 reset</span>
</code></pre> <p>The commands erase the current firmware, flash the new one, and restarts the keyboard.</p> <h2>Building A Keymap</h2> <p>From here you can use the QMK container to build your own keymaps.</p> <p>By copying the default keymaps to the /mnt folder inside the container its possible to edit the file on the host. Once edited simply copy it back to the original keymap folder and use QMK to compile it to a ".hex" file.</p> <p>For full details check out the <a href=https://beta.docs.qmk.fm/tutorial>getting started tutorial</a>. Moving the examples here into the demonstrated container workflow should be straight forward.</p> <h2>Saving Your Container</h2> <p>It is possible to "commit" the build environment if any changes are made to QMK's configuration.</p> <p>To do this you can perform a Docker commit command:</p> <pre class=hljs><code><span class=hljs-meta>$</span><span class=bash> docker commit stoic_nash qmk:custom-config</span>

</code></pre> <p>The command above will create a new container called <code>qmk:custom-config</code> based on the currently running container <code>stoic-nash</code>, a random name picked by Docker for our qmk container.</p> <h2>Conclusion</h2> <p>With this short guide we make it possible to build QMK firmware in a self-contained environment. We remove any need to install or downgrade versions of GCC and other dependencies on your host machine.</p> </article></div></div></div></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{article:{date:"2020-10-5",title:"Flashing QMK Firmware With The Help Of Docker",desc:"We explore a way to self-contain QMK dependencies use for flashing popular DIY keyboards.",file:"qmk-docker",html:"\u003Ch1\u003EFlashing QMK Firmware With The Help Of Docker\u003C\u002Fh1\u003E\n\u003Cp\u003EDIY keyboard enthusiasts enjoy soldering switches, compiling firmware, and flashing their own keyboards.\n\u003Ca href=\"https:\u002F\u002Fbeta.docs.qmk.fm\"\u003EQMK\u003C\u002Fa\u003E provides open-source firmware and tooling to make this process transparent and easy.\u003C\u002Fp\u003E\n\u003Cp\u003EWhile working on my own keyboard project I ran into a road block.\nFedora 32 is my operating system of choice and ships with GCC 10 by default.\u003C\u002Fp\u003E\n\u003Cp\u003EQMK requires AVR-GCC and GCC verion 8 to successfully flash a keyboard.\nBy default the Fedora RPM repos do not provide a down-grade path and you'd probably not want to do this anyway.\u003C\u002Fp\u003E\n\u003Cp\u003EInstead we can use a Docker container with the correct dependencies as our build environment.\u003C\u002Fp\u003E\n\u003Ch2\u003EGCC 8 Container\u003C\u002Fh2\u003E\n\u003Cp\u003EGCC containers are published on \u003Ca href=\"https:\u002F\u002Fhub.docker.com\u002F_\u002Fgcc\"\u003EDocker Hub\u003C\u002Fa\u003E.\nLooking over the tags reveal a \u003Ccode\u003Egcc:8\u003C\u002Fcode\u003E tag suitable for our build environment.\u003C\u002Fp\u003E\n\u003Ch2\u003EDockerfile\u003C\u002Fh2\u003E\n\u003Cp\u003EThe base \u003Ccode\u003Egcc:8\u003C\u002Fcode\u003E container will need additional dependencies and setup.\u003C\u002Fp\u003E\n\u003Cp\u003EThe following Dockerfile demonstrates what is necessary.\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003EFROM gcc:8\n\nRUN apt-get update &amp;&amp; export PATH=$PATH:\u002Froot\u002F.local\u002Fbin\nRUN apt install -y gcc-arm-none-eabi gcc-avr avrdude dfu-programmer dfu-util\n\nRUN curl https:\u002F\u002Fbootstrap.pypa.io\u002Fget-pip.py -o \u002Ftmp\u002Fget-pip.py &amp;&amp; python3 \u002Ftmp\u002Fget-pip.py\nRUN python3 -m pip install qmk\nRUN qmk setup -y\n\nENTRYPOINT \u002Fbin\u002Fbash\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EWe can build this container with the following command:\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E\u003Cspan class=\"hljs-meta\"\u003E$\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E docker build -t qmk:latest .\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThe above command should be ran while your shell is in the same directory of the Dockerfile.\u003C\u002Fp\u003E\n\u003Ch2\u003ERunning The Container\u003C\u002Fh2\u003E\n\u003Cp\u003EThe plan is to build the firmware in our container, where the necessary dependencies exist, get the hex file on our workstation, and flash the usb keyboard outside of the container.\u003C\u002Fp\u003E\n\u003Cp\u003EIn order to do this we must mount a directory from our workstation into the QMK container.\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E\u003Cspan class=\"hljs-meta\"\u003E$\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E mkdir ~\u002Fqmk-mnt\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-meta\"\u003E$\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E docker run -it -v \u002Fhome\u002Fldelossa\u002Fqmk-mnt:\u002Fmnt quay.io\u002Fldelossa\u002Fqmk:latest\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThe above command creates a qmk-mnt folder in my home directory and bind mounts this into the container at \u002Fmnt.\nAny files moved or copied to \u002Fmnt in the container will be accessable at ~\u002Fqmk-mnt on the host workstation.\u003C\u002Fp\u003E\n\u003Ch2\u003EBuilding Your Firmware\u003C\u002Fh2\u003E\n\u003Cp\u003EOnce inside the container we can build the firwmare and copy it to \u002Fmnt.\u003C\u002Fp\u003E\n\u003Cp\u003EI personally have an OLKB Preonic keyboard and will use the default keymap as an example.\u003C\u002Fp\u003E\n\u003Cp\u003EInside the container run the following command:\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003Eqmk compile -kb preonic\u002Frev1 -km default\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThe above command compiles the default keymap and writes the resulting elf and hex binaries to:\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E.\u002Froot\u002Fqmk_firmware\u002F.build\u002F\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EFor the preonic keyboard I am using we want to copy the &quot;.hex&quot; file to \u002Fmnt inside the container.\nThis will make it accessable from ~\u002Fqmk-mnt on the host workstation.\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E\u003Cspan class=\"hljs-meta\"\u003E$\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E cp \u002Froot\u002Fqmk_firmware\u002F.build\u002Fpreonic_rev1_default.hex \u002Fmnt\u002F\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2\u003EFlashing The Keyboard\u003C\u002Fh2\u003E\n\u003Cp\u003ENow that the firmware exists on the host workstation its possible to flash our keyboard.\u003C\u002Fp\u003E\n\u003Cp\u003EThe preonic keyboard will need &quot;dfu-programmer&quot; to write the hex file to the keyboard's micro-controller.\nLuckily this package is readily available on both Fedora and Ubuntu along with other distributions.\u003C\u002Fp\u003E\n\u003Cp\u003EWith the keyboard plugged into the host and placed in &quot;flash&quot; mode the following commands are issued:\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E\u003Cspan class=\"hljs-meta\"\u003E$\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E sudo dfu-programmer atmega32u4 erase\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-meta\"\u003E$\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E sudo dfu-programmer atmega32u4 flash ~\u002Fqmk-mnt\u002Fpreonic_rev1_default.hex\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-meta\"\u003E$\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E sudo dfu-programmer atmega32u4 reset\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThe commands erase the current firmware, flash the new one, and restarts the keyboard.\u003C\u002Fp\u003E\n\u003Ch2\u003EBuilding A Keymap\u003C\u002Fh2\u003E\n\u003Cp\u003EFrom here you can use the QMK container to build your own keymaps.\u003C\u002Fp\u003E\n\u003Cp\u003EBy copying the default keymaps to the \u002Fmnt folder inside the container its possible to edit the file on the host.\nOnce edited simply copy it back to the original keymap folder and use QMK to compile it to a &quot;.hex&quot; file.\u003C\u002Fp\u003E\n\u003Cp\u003EFor full details check out the \u003Ca href=\"https:\u002F\u002Fbeta.docs.qmk.fm\u002Ftutorial\"\u003Egetting started tutorial\u003C\u002Fa\u003E.\nMoving the examples here into the demonstrated container workflow should be straight forward.\u003C\u002Fp\u003E\n\u003Ch2\u003ESaving Your Container\u003C\u002Fh2\u003E\n\u003Cp\u003EIt is possible to &quot;commit&quot; the build environment if any changes are made to QMK's configuration.\u003C\u002Fp\u003E\n\u003Cp\u003ETo do this you can perform a Docker commit command:\u003C\u002Fp\u003E\n\u003Cpre class=\"hljs\"\u003E\u003Ccode\u003E\u003Cspan class=\"hljs-meta\"\u003E$\u003C\u002Fspan\u003E\u003Cspan class=\"bash\"\u003E docker commit stoic_nash qmk:custom-config\u003C\u002Fspan\u003E\n\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003EThe command above will create a new container called \u003Ccode\u003Eqmk:custom-config\u003C\u002Fcode\u003E based on the currently running container \u003Ccode\u003Estoic-nash\u003C\u002Fcode\u003E, a random name picked by Docker for our qmk container.\u003C\u002Fp\u003E\n\u003Ch2\u003EConclusion\u003C\u002Fh2\u003E\n\u003Cp\u003EWith this short guide we make it possible to build QMK firmware in a self-contained environment.\nWe remove any need to install or downgrade versions of GCC and other dependencies on your host machine.\u003C\u002Fp\u003E\n"}}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');</script><script src=/client/21d5f7fc0374dd879b15/main.js></script> 